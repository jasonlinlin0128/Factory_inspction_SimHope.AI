<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>乙炔區拍照巡檢</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <div class="container mx-auto p-4 max-w-lg">
        <header class="text-center mb-4">
            <h1 class="text-2xl font-bold text-gray-900">乙炔存放區巡檢</h1>
            <p class="text-gray-500">巡檢員: <span id="display-inspector-name" class="font-semibold"></span></p>
        </header>

        <!-- 拍照上傳區 -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-lg font-semibold mb-4 border-b pb-2">1. 拍照確認閥門</h2>
            <p class="text-sm text-gray-600 mb-4">請拍照確認乙炔存放區的閥門已確實關閉。**僅限使用相機即時拍照。**</p>
            
            <!-- accept="image/*" 指定接受圖片, capture="environment" 強制使用後置鏡頭 -->
            <input type="file" id="photo-input" accept="image/*" capture="environment" class="hidden">
            
            <button id="take-photo-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors mb-4">
                啟動相機拍照
            </button>
            
            <img id="photo-preview" class="hidden w-full rounded-lg mb-4" alt="照片預覽">
            
            <button id="upload-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors hidden" disabled>
                上傳並完成巡檢
            </button>

            <div id="upload-status" class="mt-4 text-center"></div>
        </section>

        <!-- 七日內巡檢紀錄 -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-lg font-semibold mb-4 border-b pb-2">2. 最近 7 日巡檢紀錄</h2>
            <div id="history-log" class="space-y-4">
                <p class="text-gray-500 text-center">正在載入紀錄...</p>
            </div>
        </section>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, updateDoc, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        // **注意：我們不再需要 Firebase Storage 的 SDK**
        // import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // TODO: 請在此貼上您的 Firebase 設定物件
const firebaseConfig = {
  apiKey: "AIzaSyCux2MYcB_BgeCxTIu_gGzezkqYZFHO8RQ",
  authDomain: "factory-inspction-simhope-ai.firebaseapp.com",
  projectId: "factory-inspction-simhope-ai",
  storageBucket: "factory-inspction-simhope-ai.firebasestorage.app",
  messagingSenderId: "386322024576",
  appId: "1:386322024576:web:fdb68ed57b162987487e65",
  measurementId: "G-HKPEP59T1P"
};
        
        // 獲取頁面元素
        const displayName = document.getElementById('display-inspector-name');
        const photoInput = document.getElementById('photo-input');
        const takePhotoButton = document.getElementById('take-photo-button');
        const photoPreview = document.getElementById('photo-preview');
        const uploadButton = document.getElementById('upload-button');
        const uploadStatus = document.getElementById('upload-status');
        const historyLog = document.getElementById('history-log');

        let db, auth;
        let inspectorName = '';
        let compressedPhotoBase64 = null; // 用來儲存壓縮後的 Base64 照片字串

        // --- 主邏輯 ---
        async function main() {
            // 初始化 Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
            } catch (error) {
                alert(`Firebase 連線失敗: ${error.message}`);
                return;
            }

            // 取得巡檢員姓名
            inspectorName = localStorage.getItem('inspectorName');
            if (!inspectorName) {
                alert('找不到巡檢員姓名，將返回主頁。');
                return;
            }
            displayName.textContent = inspectorName;

            // 綁定事件
            bindEvents();

            // 載入歷史紀錄
            loadHistory();
        }

        /**
         * 壓縮圖片並轉換為 Base64
         * @param {File} file - 使用者選擇的圖片檔案
         * @returns {Promise<string>} - 壓縮後的 Base64 字串
         */
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; // 設定最大寬度為 800px
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // 將 canvas 轉換為 JPEG 格式的 Base64，品質設為 70%
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(compressedBase64);
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }

        function bindEvents() {
            takePhotoButton.addEventListener('click', () => photoInput.click());
            
            photoInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    try {
                        // 顯示預覽 (使用未壓縮的)
                        photoPreview.src = URL.createObjectURL(file);
                        photoPreview.classList.remove('hidden');
                        
                        // 異步壓縮圖片
                        compressedPhotoBase64 = await compressImage(file);
                        
                        uploadButton.classList.remove('hidden');
                        uploadButton.disabled = false;
                        takePhotoButton.textContent = '重新拍照';
                    } catch (error) {
                        console.error("圖片壓縮失敗:", error);
                        alert("圖片處理失敗，請再試一次。");
                    }
                }
            });

            uploadButton.addEventListener('click', handleUpload);
        }

        async function handleUpload() {
            if (!compressedPhotoBase64) {
                alert('請先拍照！');
                return;
            }

            uploadButton.disabled = true;
            uploadStatus.textContent = '正在上傳紀錄...';
            uploadStatus.className = 'mt-4 text-center text-yellow-600';

            try {
                // 1. 將紀錄 (包含 Base64 照片) 寫入 Firestore (acetylene_log 集合)
                const logCollection = collection(db, 'acetylene_log');
                await addDoc(logCollection, {
                    inspectorName: inspectorName,
                    imageBase64: compressedPhotoBase64, // 儲存 Base64 字串
                    timestamp: serverTimestamp()
                });

                // 2. 更新主儀表板的狀態
                const mainPointRef = doc(db, 'inspectionPoints', 'acetylene');
                await updateDoc(mainPointRef, {
                    status: 'inspected',
                    inspectorName: inspectorName,
                    timestamp: serverTimestamp()
                });

                uploadStatus.textContent = '巡檢成功！';
                uploadStatus.className = 'mt-4 text-center text-green-600';
                
                // 成功後重新載入歷史紀錄
                loadHistory();

            } catch (error) {
                console.error("上傳失敗:", error);
                uploadStatus.textContent = `上傳失敗: ${error.message}`;
                uploadStatus.className = 'mt-4 text-center text-red-600';
                uploadButton.disabled = false;
            }
        }

        async function loadHistory() {
            historyLog.innerHTML = '<p class="text-gray-500 text-center">正在載入紀錄...</p>';
            
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            const logCollection = collection(db, 'acetylene_log');
            const q = query(logCollection, where("timestamp", ">=", sevenDaysAgo));

            try {
                const querySnapshot = await getDocs(q);
                let logs = [];
                querySnapshot.forEach((doc) => {
                    logs.push(doc.data());
                });

                logs.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

                if (logs.length === 0) {
                    historyLog.innerHTML = '<p class="text-gray-500 text-center">最近 7 日無巡檢紀錄。</p>';
                    return;
                }

                historyLog.innerHTML = ''; // 清空
                logs.forEach(log => {
                    const logDate = log.timestamp.toDate();
                    const formattedTime = logDate.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
                    
                    const logElement = document.createElement('div');
                    logElement.className = 'border p-3 rounded-md bg-gray-50';
                    // **直接使用 Base64 字串作為圖片來源**
                    logElement.innerHTML = `
                        <p class="font-semibold">${log.inspectorName}</p>
                        <p class="text-sm text-gray-500">${formattedTime}</p>
                        <img src="${log.imageBase64}" alt="巡檢照片" class="w-full h-auto max-h-48 object-cover rounded-md mt-1">
                    `;
                    historyLog.appendChild(logElement);
                });

            } catch (error)
            {
                console.error("讀取歷史紀錄失敗:", error);
                historyLog.innerHTML = `<p class="text-red-500 text-center">讀取紀錄失敗: ${error.message}</p>`;
            }
        }

        // 啟動應用程式
        main();
    </script>
</body>
</html>
