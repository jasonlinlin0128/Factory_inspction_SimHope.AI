<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NFC 巡檢掃描</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { height: 100%; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center h-full font-sans p-4">

    <div id="message-container" class="text-center">
        <p id="main-message" class="text-2xl text-yellow-400">正在處理巡檢點...</p>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // TODO: 請在此貼上您的 Firebase 設定物件
const firebaseConfig = {
  apiKey: "AIzaSyCux2MYcB_BgeCxTIu_gGzezkqYZFHO8RQ",
  authDomain: "factory-inspction-simhope-ai.firebaseapp.com",
  projectId: "factory-inspction-simhope-ai",
  storageBucket: "factory-inspction-simhope-ai.firebasestorage.app",
  messagingSenderId: "386322024576",
  appId: "1:386322024576:web:fdb68ed57b162987487e65",
  measurementId: "G-HKPEP59T1P"
};
        
        const mainMessage = document.getElementById('main-message');

        /**
         * 針對非拍照點的標準巡檢流程
         */
        async function handleStandardInspection(db, pointId, inspectorName) {
            const pointRef = doc(db, 'inspectionPoints', pointId);
            try {
                mainMessage.textContent = `正在更新 [${pointId}]...`;
                await updateDoc(pointRef, {
                    status: 'inspected',
                    inspectorName: inspectorName,
                    timestamp: serverTimestamp()
                });
                mainMessage.textContent = `[${pointId}] 已巡檢成功！`;
                mainMessage.className = 'text-2xl text-green-400';
                if ('vibrate' in navigator) navigator.vibrate(200);
            } catch (error) {
                mainMessage.textContent = `更新失敗: ${error.code || error.message}`;
                mainMessage.className = 'text-xl text-red-400';
            }
        }

        /**
         * 主程式進入點
         */
        async function main() {
            if (!firebaseConfig || firebaseConfig.apiKey === "YOUR_API_KEY") {
                mainMessage.textContent = 'Firebase 設定錯誤！';
                mainMessage.className = 'text-xl text-red-400';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const pointId = urlParams.get('id');

            if (!pointId) {
                mainMessage.textContent = '無效的巡檢點 ID。';
                return;
            }

            // **核心邏輯：判斷巡檢點並導向**
            if (pointId === 'acetylene') {
                mainMessage.textContent = '偵測到乙炔存放區，正在導向專用頁面...';
                // 將參數一起帶過去
                window.location.href = `acetylene.html${window.location.search}`;
                return; // 結束執行
            }

            // --- 對於其他所有標準巡檢點，執行以下流程 ---
            const inspectorName = localStorage.getItem('inspectorName');
            if (!inspectorName) {
                // 如果沒有姓名，先跳轉回主頁讓使用者輸入
                // 這裡假設使用者會先從一個有輸入框的頁面開始，或直接在 URL 帶參數
                // 為了簡化，我們暫時相信 localStorage 裡有名字
                // 一個更完整的系統會需要一個統一的登入/姓名輸入頁面
                alert('找不到巡檢員姓名，請先完成簽名設定。');
                mainMessage.textContent = '找不到巡檢員姓名。';
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                await handleStandardInspection(db, pointId, inspectorName);
            } catch (error) {
                mainMessage.textContent = `連線失敗: ${error.code || error.message}`;
                mainMessage.className = 'text-xl text-red-400';
            }
        }

        main();
    </script>
</body>
</html>
