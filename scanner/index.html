<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NFC 巡檢掃描</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 確保在行動裝置上滿版顯示 */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        /* 按鈕點擊時的動畫效果 */
        .scan-button:active {
            transform: scale(0.95);
            filter: brightness(0.9);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center h-full font-sans p-4">

    <div id="name-input-section" class="w-full max-w-sm text-center">
        <h1 class="text-3xl font-bold mb-4">巡檢員簽名</h1>
        <p class="text-gray-400 mb-6">請輸入您的姓名或工號</p>
        <input type="text" id="inspector-name-input" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white text-center text-lg focus:outline-none focus:border-cyan-500" placeholder="例如：王大明">
        <button id="save-name-button" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg mt-4 transition-colors">
            確認姓名
        </button>
    </div>

    <div id="scanner-section" class="hidden w-full h-full flex flex-col items-center justify-between text-center p-4">
        <!-- 頂部資訊區 -->
        <header class="w-full">
            <p class="text-lg">巡檢員: <span id="display-inspector-name" class="font-bold text-cyan-400"></span></p>
            <button id="change-name-button" class="text-sm text-gray-400 underline mt-1">更換姓名</button>
        </header>

        <!-- 主掃描按鈕區 -->
        <main class="flex flex-col items-center justify-center flex-grow">
            <button id="scan-button" class="scan-button w-64 h-64 bg-cyan-600 rounded-full flex items-center justify-center text-white text-4xl font-bold shadow-lg transition-transform transform active:scale-95 focus:outline-none">
                開始掃描
            </button>
            <p id="status-message" class="mt-8 text-xl h-10 text-gray-300"></p>
        </main>
        
        <!-- 底部提示區 -->
        <footer class="w-full pb-4">
            <p class="text-gray-500">請將手機靠近 NFC 標籤</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCux2MYcB_BgeCxTIu_gGzezkqYZFHO8RQ",
  authDomain: "factory-inspction-simhope-ai.firebaseapp.com",
  projectId: "factory-inspction-simhope-ai",
  storageBucket: "factory-inspction-simhope-ai.firebasestorage.app",
  messagingSenderId: "386322024576",
  appId: "1:386322024576:web:fdb68ed57b162987487e65",
  measurementId: "G-HKPEP59T1P"
};
        
        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 獲取頁面元素
        const nameInputSection = document.getElementById('name-input-section');
        const scannerSection = document.getElementById('scanner-section');
        const inspectorNameInput = document.getElementById('inspector-name-input');
        const saveNameButton = document.getElementById('save-name-button');
        const displayInspectorName = document.getElementById('display-inspector-name');
        const changeNameButton = document.getElementById('change-name-button');
        const scanButton = document.getElementById('scan-button');
        const statusMessage = document.getElementById('status-message');

        let inspectorName = '';

        /**
         * 顯示訊息並在一段時間後清除
         * @param {string} message - 要顯示的訊息
         * @param {boolean} isError - 是否為錯誤訊息
         */
        function showMessage(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError 
                ? 'mt-8 text-xl h-10 text-red-400' 
                : 'mt-8 text-xl h-10 text-green-400';
            
            setTimeout(() => {
                statusMessage.textContent = '';
            }, 3000); // 3秒後清除訊息
        }

        /**
         * 更新 Firestore 中的巡檢點資料
         * @param {string} pointId - 巡檢點 ID (從 NFC 標籤讀取)
         */
        async function updateInspectionPoint(pointId) {
            if (!pointId) return;

            const pointRef = doc(db, 'inspectionPoints', pointId);
            try {
                await updateDoc(pointRef, {
                    status: 'inspected',
                    inspectorName: inspectorName,
                    timestamp: serverTimestamp()
                });
                
                // 提供成功回饋
                showMessage(`[${pointId}] 已巡檢成功！`);
                if ('vibrate' in navigator) {
                    navigator.vibrate(200); // 震動 200 毫秒
                }
            } catch (error) {
                console.error("更新 Firestore 失敗: ", error);
                showMessage(`更新失敗: ${pointId}`, true);
            }
        }

        /**
         * 初始化 Web NFC 功能
         */
        function initNFC() {
            // 檢查瀏覽器是否支援 Web NFC
            if (!('NDEFReader' in window)) {
                showMessage("此瀏覽器不支援 Web NFC", true);
                scanButton.disabled = true;
                scanButton.textContent = '不支援';
                scanButton.classList.add('bg-gray-700');
                scanButton.classList.remove('bg-cyan-600');
                return;
            }

            scanButton.addEventListener('click', async () => {
                try {
                    const reader = new NDEFReader();
                    await reader.scan(); // 開始掃描
                    statusMessage.textContent = '準備掃描...';
                    statusMessage.className = 'mt-8 text-xl h-10 text-yellow-400';

                    reader.addEventListener('reading', ({ message, serialNumber }) => {
                        const record = message.records[0];
                        if (record.recordType === "text") {
                            const textDecoder = new TextDecoder(record.encoding);
                            const pointId = textDecoder.decode(record.data);
                            console.log(`讀取到 NFC 標籤: ${pointId}`);
                            updateInspectionPoint(pointId);
                        }
                    });

                    reader.addEventListener('error', (event) => {
                        console.error('NFC 讀取錯誤: ', event);
                        showMessage('NFC 讀取錯誤', true);
                    });

                } catch (error) {
                    console.error('啟動 NFC 掃描失敗: ', error);
                    showMessage('無法啟動掃描功能', true);
                }
            });
        }
        
        /**
         * 處理姓名儲存與介面切換
         */
        function handleNameSetup() {
            // 儲存姓名
            const name = inspectorNameInput.value.trim();
            if (name) {
                inspectorName = name;
                localStorage.setItem('inspectorName', name);
                displayInspectorName.textContent = name;
                nameInputSection.classList.add('hidden');
                scannerSection.classList.remove('hidden');
            } else {
                alert('請輸入您的姓名或工號');
            }
        }

        // 頁面載入時的初始化邏輯
        function initialize() {
            // 檢查 localStorage 是否已儲存姓名
            const savedName = localStorage.getItem('inspectorName');
            if (savedName) {
                inspectorName = savedName;
                displayInspectorName.textContent = savedName;
                nameInputSection.classList.add('hidden');
                scannerSection.classList.remove('hidden');
            } else {
                nameInputSection.classList.remove('hidden');
                scannerSection.classList.add('hidden');
            }
            
            // 綁定事件
            saveNameButton.addEventListener('click', handleNameSetup);
            inspectorNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleNameSetup();
                }
            });

            changeNameButton.addEventListener('click', () => {
                localStorage.removeItem('inspectorName');
                nameInputSection.classList.remove('hidden');
                scannerSection.classList.add('hidden');
                inspectorNameInput.value = '';
            });

            initNFC();
        }

        // 執行初始化
        initialize();

    </script>
</body>
</html>
