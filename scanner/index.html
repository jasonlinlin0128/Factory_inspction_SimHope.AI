<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NFC 巡檢掃描</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { height: 100%; }
        .loader {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            position: relative;
            animation: rotate 1s linear infinite;
        }
        .loader::before, .loader::after {
            content: "";
            box-sizing: border-box;
            position: absolute;
            inset: 0px;
            border-radius: 50%;
            border: 5px solid #FFF;
            animation: prixClipFix 2s linear infinite;
        }
        .loader::after {
            border-color: #3b82f6;
            animation: prixClipFix 2s linear infinite, rotate 0.5s linear infinite reverse;
            inset: 6px;
        }
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes prixClipFix {
            0% { clip-path: polygon(50% 50%, 0 0, 0 0, 0 0, 0 0, 0 0); }
            25% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 0, 100% 0, 100% 0); }
            50% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 100% 100%, 100% 100%); }
            75% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 0 100%, 0 100%); }
            100% { clip-path: polygon(50% 50%, 0 0, 100% 0, 100% 100%, 0 100%, 0 0); }
        }
    </style>
</head>
<body class="bg-black text-white flex flex-col items-center justify-center h-full font-sans p-4">

    <div id="message-container" class="text-center flex flex-col items-center space-y-6">
        <div class="loader"></div>
        <p id="main-message" class="text-xl text-gray-300">正在處理巡檢點...</p>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, updateDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCux2MYcB_BgeCxTIu_gGzezkqYZFHO8RQ",
            authDomain: "factory-inspction-simhope-ai.firebaseapp.com",
            projectId: "factory-inspction-simhope-ai",
            storageBucket: "factory-inspction-simhope-ai.appspot.com",
            messagingSenderId: "386322024576",
            appId: "1:386322024576:web:fdb68ed57b162987487e65",
            measurementId: "G-HKPEP59T1P"
        };
        
        const mainMessage = document.getElementById('main-message');

        async function handleStandardInspection(db, pointId, inspectorName) {
            const pointRef = doc(db, 'inspectionPoints', pointId);
            try {
                mainMessage.textContent = `正在更新 [${pointId}]...`;
                await updateDoc(pointRef, {
                    status: 'inspected',
                    inspectorName: inspectorName,
                    timestamp: serverTimestamp()
                });
                const logCollection = collection(db, 'standard_inspection_log');
                await addDoc(logCollection, {
                    pointId: pointId,
                    inspectorName: inspectorName,
                    timestamp: serverTimestamp()
                });
                mainMessage.textContent = `[${pointId}] 已巡檢成功！`;
                mainMessage.parentElement.querySelector('.loader').style.display = 'none';
                mainMessage.className = 'text-2xl text-green-400';
                if ('vibrate' in navigator) navigator.vibrate(200);
            } catch (error) {
                mainMessage.textContent = `更新失敗: ${error.code || error.message}`;
                mainMessage.parentElement.querySelector('.loader').style.display = 'none';
                mainMessage.className = 'text-xl text-red-400';
            }
        }

        async function main() {
            if (!firebaseConfig || firebaseConfig.apiKey === "YOUR_API_KEY") {
                mainMessage.textContent = 'Firebase 設定錯誤！';
                mainMessage.className = 'text-xl text-red-400';
                return;
            }
            const urlParams = new URLSearchParams(window.location.search);
            const pointId = urlParams.get('id');
            if (!pointId) {
                mainMessage.textContent = '無效的巡檢點 ID。';
                return;
            }
            if (pointId === 'acetylene') {
                mainMessage.textContent = '偵測到乙炔存放區，正在導向專用頁面...';
                window.location.href = `acetylene.html${window.location.search}`;
                return;
            }
            const inspectorName = localStorage.getItem('inspectorName');
            if (!inspectorName) {
                alert('找不到巡檢員姓名，請先完成簽名設定。');
                mainMessage.textContent = '找不到巡檢員姓名。';
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                await handleStandardInspection(db, pointId, inspectorName);
            } catch (error) {
                mainMessage.textContent = `連線失敗: ${error.code || error.message}`;
                mainMessage.className = 'text-xl text-red-400';
            }
        }
        main();
    </script>
</body>
</html>
